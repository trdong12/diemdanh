<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>H·ªá Th·ªëng ƒêi·ªÉm Danh - HUIT</title>
    
    <!-- Th∆∞ vi·ªán -->
    <script src="https://cdn.jsdelivr.net/npm/easyqrcodejs@4.5.0/dist/easy.qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- C·∫§U H√åNH GIAO DI·ªÜN CHUNG --- */
        :root {
            --primary: #0056b3;
            --primary-gradient: linear-gradient(135deg, #0056b3 0%, #003d82 100%);
            --accent: #f59e0b;
            --bg-body: #f3f4f6;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --radius: 10px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; }

        body {
            margin: 0; padding: 0;
            background: var(--bg-body);
            color: var(--text-dark);
            height: 100vh;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* ·∫®n hi·ªán c√°c View */
        .view-section { display: none; width: 100%; height: 100%; }
        .view-section.active { display: flex; flex-direction: column; }

        /* ============================================================
           CSS CHO GIAO DI·ªÜN SINH VI√äN (STUDENT)
           ============================================================ */
        #student-view {
            overflow-y: auto;
            justify-content: center; align-items: center;
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            padding: 20px;
        }
        
        .st-card {
            background: white; width: 100%; max-width: 400px; padding: 30px;
            border-radius: 20px; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1);
            text-align: center; margin: auto;
        }
        .st-logo { width: 80px; margin-bottom: 10px; }
        .st-title { color: var(--primary); margin: 0; font-size: 20px; font-weight: 800; text-transform: uppercase; }
        
        .st-group { margin-bottom: 15px; text-align: left; }
        .st-inp { 
            width: 100%; padding: 12px; border: 1px solid var(--border); 
            border-radius: 8px; background: #f9fafb; outline: none;
        }
        .st-inp:focus { border-color: var(--primary); background: white; }
        
        .st-btn {
            width: 100%; padding: 14px; background: var(--primary); color: white;
            border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
            margin-top: 10px; transition: 0.2s;
        }
        .st-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        
        .loc-box {
            background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* ============================================================
           CSS CHO GIAO DI·ªÜN GI·∫¢NG VI√äN (ADMIN/TEACHER)
           ============================================================ */
        header {
            flex: 0 0 auto; background: white; padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); z-index: 20; position: relative;
        }
        header::after {
            content: ""; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo-link img { height: 50px; width: auto; object-fit: contain; }
        .header-info h3 { font-size: 12px; font-weight: 700; color: var(--text-light); margin: 0; text-transform: uppercase; }
        .header-info h1 { font-size: 18px; font-weight: 800; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 2px 0 0 0; text-transform: uppercase; }

        .main-container {
            flex: 1; display: grid; grid-template-columns: 360px 1fr;
            overflow: hidden; min-height: 0;
        }

        .sidebar {
            background: #f9fafb; border-right: 1px solid var(--border);
            padding: 20px; overflow-y: auto; height: 100%;
            display: flex; flex-direction: column; gap: 15px; padding-bottom: 50px;
        }
        .sidebar::-webkit-scrollbar { width: 8px; }
        .sidebar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }

        .config-card {
            background: white; border-radius: var(--radius); padding: 15px;
            box-shadow: var(--shadow); border: 1px solid var(--border);
        }
        .config-card.blue-border { border-left: 4px solid var(--primary); }
        .config-card.orange-border { border-left: 4px solid var(--accent); }
        .card-title { font-size: 13px; font-weight: 700; color: var(--text-dark); text-transform: uppercase; margin-bottom: 12px; border-bottom: 1px dashed var(--border); padding-bottom: 8px; }

        .form-group { margin-bottom: 12px; }
        label { display: flex; justify-content: space-between; font-size: 12px; font-weight: 600; color: var(--text-light); margin-bottom: 5px; }
        input[type="text"], input[type="number"], select {
            width: 100%; padding: 8px 12px; border: 1px solid var(--border);
            border-radius: 6px; font-size: 13px; background: #f9fafb;
        }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 6px; background: #e5e7eb; border-radius: 5px; margin-top: 5px; cursor: pointer; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; background: var(--primary); border-radius: 50%; cursor: pointer; }
        .row-2 { display: flex; gap: 10px; } .col { flex: 1; }
        input[type="color"] { width: 100%; height: 35px; border: 1px solid var(--border); padding: 2px; cursor: pointer; background: white; }

        .btn-group { display: flex; gap: 10px; margin-top: 5px; }
        .btn { padding: 10px; border: none; border-radius: 6px; font-weight: 600; font-size: 12px; cursor: pointer; width: 100%; color: white; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-print { background: linear-gradient(135deg, #10b981 0%, #059669 100%); font-size: 14px; padding: 12px; margin-top: 10px; }
        .btn-pdf { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .btn-reset { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }

        .warning-box { background: #fff1f2; border-left: 4px solid #e11d48; color: #be123c; padding: 12px; border-radius: 6px; font-size: 12px; margin-top: 10px; display: none; }

        .preview-area {
            background-color: #e5e7eb; background-image: radial-gradient(#9ca3af 1px, transparent 1px); background-size: 20px 20px;
            padding: 40px; overflow: auto; display: flex; justify-content: center; height: 100%;
        }
        .paper-sheet { background: white; box-shadow: 0 20px 50px rgba(0,0,0,0.1); padding: 20px; display: flex; flex-wrap: wrap; align-content: flex-start; justify-content: flex-start; width: 210mm; min-height: 297mm; transition: all 0.3s ease; }
        .qr-item { display: flex; flex-direction: column; align-items: center; border: 1px dashed #d1d5db; box-sizing: border-box; }
        .qr-item img { width: 100%; height: auto; display: block; }

        footer {
            flex: 0 0 auto; background: white; border-top: 1px solid var(--border); padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--text-light); z-index: 10;
        }

        @media print {
            body { background: white; display: block; height: auto; overflow: visible; }
            header, .sidebar, footer, #student-view { display: none !important; }
            #teacher-view { display: block !important; }
            .main-container { display: block; height: auto; }
            .preview-area { padding: 0; display: block; background: white; position: absolute; top: 0; left: 0; }
            .paper-sheet { margin: 0; box-shadow: none; padding: 0; width: 100% !important; height: auto !important; }
            .qr-item { border: none !important; }
        }
    </style>
</head>

<body>

    <!-- ======================================================= -->
    <!-- VIEW 1: STUDENT (SINH VI√äN) - ƒêi·ªÉm danh -->
    <!-- ======================================================= -->
    <div id="student-view" class="view-section">
        <div class="st-card">
            <img src="https://lh3.googleusercontent.com/d/1oyqHPWlAPO2plc5tDbZnPwpbb4xV6bkL" class="st-logo">
            <h2 class="st-title">ƒêi·ªÉm Danh Online</h2>
            <p style="color:#666; font-size:13px; margin-bottom:20px;">Tr∆∞·ªùng ƒêH C√¥ng Th∆∞∆°ng TP.HCM</p>

            <!-- Box ƒë·∫øm ng∆∞·ª£c khi b·ªã ch·∫∑n -->
            <div id="cooldown-box" style="display:none; background:#fff3cd; color:#856404; padding:15px; border-radius:10px; margin-bottom:15px;">
                üö´ <b>Thi·∫øt b·ªã n√†y ƒë√£ s·ª≠ d·ª•ng!</b><br>
                Quay l·∫°i sau: <span id="countdown" style="font-weight:800; font-size:18px; display:block; margin-top:5px;">--:--</span>
            </div>

            <!-- N√∫t b·∫≠t v·ªã tr√≠ -->
            <div class="loc-box">
                <div style="text-align:left;">
                    <span id="loc-icon">üìç</span> 
                    <span id="loc-text" style="font-weight:600;">V·ªã tr√≠: ƒêang t·∫Øt</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="locationToggle" onchange="toggleLocation()">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- Form ƒëi·ªÅn th√¥ng tin -->
            <form id="attendanceForm" onsubmit="handleStudentSubmit(event)">
                <div class="st-group"><input type="text" id="name" class="st-inp" placeholder="H·ªç v√† T√™n" required disabled></div>
                <div class="st-group"><input type="number" id="mssv" class="st-inp" placeholder="M√£ S·ªë Sinh Vi√™n" required disabled></div>
                <div class="st-group"><input type="text" id="lop" class="st-inp" placeholder="L·ªõp (VD: 12DHTH01)" required disabled></div>
                <div class="st-group"><input type="text" id="mon" class="st-inp" placeholder="M√¥n H·ªçc" required disabled></div>
                
                <input type="hidden" id="lat"><input type="hidden" id="lng">
                <button type="submit" id="btnSubmit" class="st-btn" disabled>üîí Vui l√≤ng b·∫≠t v·ªã tr√≠</button>
            </form>
            <div id="status" style="margin-top:15px; font-size:14px;"></div>
        </div>
    </div>


    <!-- ======================================================= -->
    <!-- VIEW 2: TEACHER (GI·∫¢NG VI√äN) - T·∫°o QR & In ·∫§n -->
    <!-- ======================================================= -->
    <div id="teacher-view" class="view-section">
        <header>
            <div class="header-left">
                <a href="#" class="logo-link">
                    <img src="https://lh3.googleusercontent.com/d/1oyqHPWlAPO2plc5tDbZnPwpbb4xV6bkL" alt="Logo">
                </a>
                <div class="header-info">
                    <h3>Tr∆∞·ªùng ƒêH C√¥ng Th∆∞∆°ng TP.HCM</h3>
                    <h1>H·ªá Th·ªëng ƒêi·ªÉm Danh QR</h1>
                </div>
            </div>
            <div><i class="fas fa-user-circle" style="font-size: 24px; color: #cbd5e1;"></i></div>
        </header>

        <div class="main-container">
            <div class="sidebar">
                <div class="config-card blue-border">
                    <div class="card-title"><i class="fas fa-palette"></i> Thi·∫øt K·∫ø QR</div>
                    <div class="form-group">
                        <label>Link Web App:</label>
                        <input type="text" id="inp-text" readonly placeholder="ƒêang t·∫£i..." style="color:#6b7280; background:#eee;">
                    </div>
                    <div class="form-group">
                        <label>K√≠ch th∆∞·ªõc: <span id="lbl-size" style="color:var(--primary); font-weight:bold;">100</span> mm</label>
                        <input type="range" id="inp-size" min="20" max="300" value="100" oninput="autoUpdate()">
                    </div>
                    <div class="row-2 form-group">
                        <div class="col"><label>M√†u Module:</label><input type="color" id="col-dark" value="#000000" oninput="autoUpdate()"></div>
                        <div class="col"><label>M√†u N·ªÅn:</label><input type="color" id="col-light" value="#ffffff" oninput="autoUpdate()"></div>
                    </div>
                    <div class="row-2 form-group">
                        <div class="col">
                            <label>Style:</label>
                            <select id="sel-style" onchange="autoUpdate()"><option value="1.0">Vu√¥ng</option><option value="0.4">Tr√≤n</option></select>
                        </div>
                        <div class="col">
                            <label>S·ª≠a l·ªói:</label>
                            <select id="sel-correct" onchange="autoUpdate()"><option value="L">L</option><option value="M" selected>M</option><option value="Q">Q</option><option value="H">H</option></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Margin:</label><input type="number" id="inp-quiet" value="2" min="0" oninput="autoUpdate()">
                    </div>
                    <div class="form-group">
                        <label>Logo:</label><input type="file" id="inp-logo" accept="image/*">
                    </div>
                </div>

                <div class="config-card orange-border">
                    <div class="card-title"><i class="fas fa-print"></i> In ·∫§n & Xu·∫•t File</div>
                    <div class="form-group">
                        <label>Kh·ªï gi·∫•y:</label>
                        <select id="sel-paper" onchange="handlePaperChange()">
                            <option value="210,297" selected>A4</option>
                            <option value="297,420">A3</option>
                            <option value="148,210">A5</option>
                        </select>
                    </div>
                    <div class="row-2 form-group">
                        <div class="col"><label>S·ªë l∆∞·ª£ng:</label><input type="number" id="inp-qty" value="1" min="1" oninput="autoUpdate()"></div>
                        <div class="col"><label>Kho·∫£ng c√°ch (mm):</label><input type="number" id="inp-gap" value="10" min="0" oninput="autoUpdate()"></div>
                    </div>
                </div>

                <div id="msg-warning" class="warning-box">
                    <i class="fas fa-exclamation-triangle"></i> <b>C·∫£nh b√°o:</b> Gi·∫•y ch·ªâ ch·ª©a t·ªëi ƒëa <span id="max-qty">0</span> QR.
                </div>

                <div class="btn-group">
                    <button class="btn btn-pdf" onclick="downloadPDF()"><i class="fas fa-file-pdf"></i> T·∫£i PDF</button>
                    <button class="btn btn-reset" onclick="resetDefaults()"><i class="fas fa-undo"></i> Reset</button>
                </div>
                <button id="btn-print" class="btn btn-print" onclick="window.print()"><i class="fas fa-print"></i> IN NGAY</button>
            </div>

            <div class="preview-area">
                <div id="paper" class="paper-sheet"></div>
            </div>
        </div>

        <footer>
            <div class="footer-left">&copy; 2025 <strong>HUIT Attendance</strong></div>
            <div class="footer-right">Developed by Student HUIT</div>
        </footer>
        <div id="qr-hidden" style="display:none;"></div>
    </div>

    <script>
        // ================================================================
        // üî¥ C·∫§U H√åNH: D√ÅN LINK WEB APP C·ª¶A B·∫†N V√ÄO ƒê√ÇY
        // ================================================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/library/d/14Zu5P6MOnO6-8JZdCopXx3z67jidcHNCus6IEvKM6JbR35eV5aVNMxk4/3"; 
        
        // --- KH·ªûI T·∫†O BI·∫æN TO√ÄN C·ª§C ---
        const COOLDOWN_TIME = 2 * 60 * 60 * 1000;
        let qrLogo = "";
        let baseQRImage = "";
        let timeout = null;
        let currentPaperW = 210;
        let currentPaperH = 297;
        let currentSessionCode = ""; // L∆∞u m√£ phi√™n

        // --- H√ÄM T·∫†O M√É NG·∫™U NHI√äN 7 K√ù T·ª∞ ---
        function generateRandomCode(length) {
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        // --- 1. ROUTING (CHUY·ªÇN TRANG ADMIN / STUDENT) ---
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const view = params.get('v');
            
            if (view === 'admin') {
                // --- CH·∫æ ƒê·ªò GI·∫¢NG VI√äN ---
                document.getElementById('teacher-view').classList.add('active');
                
                // T·∫°o m√£ phi√™n ng·∫´u nhi√™n
                currentSessionCode = generateRandomCode(7);
                
                // L·∫•y link g·ªëc v√† x·ª≠ l√Ω
                let baseUrl = window.location.href.split('?')[0];
                if (baseUrl.endsWith('/')) baseUrl = baseUrl.slice(0, -1);
                
                // T·∫°o link k√®m m√£
                const finalLink = baseUrl + "?c=" + currentSessionCode;
                document.getElementById('inp-text').value = finalLink;
                
                handlePaperChange();

            } else {
                // --- CH·∫æ ƒê·ªò SINH VI√äN ---
                document.getElementById('student-view').classList.add('active');
                checkCooldown();
            }
        };

        // ================================================================
        // LOGIC ADMIN (TEACHER)
        // ================================================================
        function handlePaperChange() {
            const val = document.getElementById('sel-paper').value.split(',');
            currentPaperW = parseInt(val[0]);
            currentPaperH = parseInt(val[1]);
            const paper = document.getElementById('paper');
            paper.style.width = currentPaperW + 'mm';
            paper.style.minHeight = currentPaperH + 'mm';
            autoUpdate();
        }

        function autoUpdate() {
            document.getElementById('lbl-size').innerText = document.getElementById('inp-size').value;
            checkFitCapacity();
            clearTimeout(timeout);
            timeout = setTimeout(renderQRCode, 100);
        }

        function checkFitCapacity() {
            const qrSize = parseInt(document.getElementById('inp-size').value);
            const gap = parseInt(document.getElementById('inp-gap').value);
            const reqQty = parseInt(document.getElementById('inp-qty').value);
            const paddingPaper = 40; 
            const usableW = currentPaperW - paddingPaper; 
            const usableH = currentPaperH - paddingPaper;
            const itemFullSize = qrSize + gap;

            if (qrSize > usableW || qrSize > usableH) {
                showWarning(0, "K√≠ch th∆∞·ªõc QR qu√° l·ªõn!"); return;
            }
            const cols = Math.floor((usableW + gap) / itemFullSize); 
            const rows = Math.floor((usableH + gap) / itemFullSize);
            const maxCap = Math.max(0, cols * rows);

            if (reqQty > maxCap) showWarning(maxCap);
            else hideWarning();
        }

        function showWarning(maxQty, msg) {
            const box = document.getElementById('msg-warning');
            const span = document.getElementById('max-qty');
            box.style.display = 'block';
            if (msg) box.innerHTML = `<i class='fas fa-exclamation-circle'></i> <b>L·ªói:</b> ${msg}`;
            else { span.innerText = maxQty; box.innerHTML = `<i class='fas fa-exclamation-triangle'></i> <b>Qu√° t·∫£i:</b> T·ªëi ƒëa <b>${maxQty}</b> QR/trang.`; }
            document.getElementById('btn-print').disabled = true;
        }

        function hideWarning() {
            document.getElementById('msg-warning').style.display = 'none';
            document.getElementById('btn-print').disabled = false;
        }

        document.getElementById('inp-logo').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (ev) { qrLogo = ev.target.result; autoUpdate(); };
                reader.readAsDataURL(file);
            } else { qrLogo = ""; autoUpdate(); }
        });

        function renderQRCode() {
            const text = document.getElementById('inp-text').value;
            if(!text) return;
            const hidden = document.getElementById('qr-hidden');
            hidden.innerHTML = "";
            
            const lvlMap = {'L': QRCode.CorrectLevel.L, 'M': QRCode.CorrectLevel.M, 'Q': QRCode.CorrectLevel.Q, 'H': QRCode.CorrectLevel.H};

            new QRCode(hidden, {
                text: text,
                width: 1000, height: 1000,
                colorDark: document.getElementById('col-dark').value,
                colorLight: document.getElementById('col-light').value,
                correctLevel: lvlMap[document.getElementById('sel-correct').value],
                quietZone: parseInt(document.getElementById('inp-quiet').value) || 0,
                quietZoneColor: document.getElementById('col-light').value,
                dotScale: parseFloat(document.getElementById('sel-style').value),
                logo: qrLogo || undefined,
                logoWidth: 250, logoHeight: 250,
                logoBackgroundColor: document.getElementById('col-light').value
            });

            setTimeout(() => {
                const canvas = hidden.querySelector('canvas');
                if (canvas) {
                    baseQRImage = canvas.toDataURL("image/png");
                    generateSheet();
                }
            }, 50);
        }

        function generateSheet() {
            if (!baseQRImage) return;
            const paper = document.getElementById('paper');
            paper.innerHTML = "";
            const qty = parseInt(document.getElementById('inp-qty').value) || 1;
            const sizeMM = parseInt(document.getElementById('inp-size').value) || 100;
            const gapMM = parseInt(document.getElementById('inp-gap').value) || 10;
            
            for (let i = 0; i < qty; i++) {
                const item = document.createElement('div');
                item.className = 'qr-item';
                item.style.width = sizeMM + 'mm';
                item.style.marginRight = gapMM + 'mm'; 
                item.style.marginBottom = gapMM + 'mm';
                const img = document.createElement('img');
                img.src = baseQRImage;
                item.appendChild(img);
                paper.appendChild(item);
            }
        }

        function downloadPDF() {
            const element = document.getElementById('paper');
            const btn = document.querySelector('.btn-pdf');
            const oldHtml = btn.innerHTML;
            btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> ƒêang x·ª≠ l√Ω..."; btn.disabled = true;
            const opt = {
                margin: 0, filename: 'QR_Code_HUIT.pdf', image: { type: 'jpeg', quality: 1 },
                html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: [currentPaperW, currentPaperH], orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save().then(() => { btn.innerHTML = oldHtml; btn.disabled = false; });
        }

        function resetDefaults() {
            if (confirm("Reset v·ªÅ m·∫∑c ƒë·ªãnh?")) location.reload();
        }

        // ================================================================
        // LOGIC STUDENT (SINH VI√äN)
        // ================================================================
        function getDeviceId() {
            let id = localStorage.getItem('unique_device_id');
            if(!id) { id = 'DEV-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5); localStorage.setItem('unique_device_id', id); }
            return id;
        }

        function checkCooldown() {
            const last = localStorage.getItem('lastAttendanceTime');
            if(last && (Date.now() - last < COOLDOWN_TIME)) {
                showCooldown(COOLDOWN_TIME - (Date.now() - last));
                return true;
            }
            return false;
        }

        function showCooldown(ms) {
            document.getElementById('attendanceForm').style.display='none';
            document.getElementById('locationToggle').disabled=true;
            document.getElementById('cooldown-box').style.display='block';
            
            const end = Date.now() + ms;
            const interval = setInterval(() => {
                const dist = end - Date.now();
                if(dist < 0) {
                    clearInterval(interval);
                    document.getElementById('cooldown-box').style.display='none';
                    document.getElementById('attendanceForm').style.display='block';
                    document.getElementById('locationToggle').disabled=false;
                    localStorage.removeItem('lastAttendanceTime');
                } else {
                    const h = Math.floor(dist/(1000*60*60));
                    const m = Math.floor((dist%(1000*60*60))/(1000*60));
                    const s = Math.floor((dist%(1000*60))/1000);
                    document.getElementById('countdown').innerText = `${h}h ${m}m ${s}s`;
                }
            }, 1000);
        }

        function toggleLocation() {
            if(checkCooldown()) return;
            const chk = document.getElementById('locationToggle');
            const inputs = document.querySelectorAll('.st-inp');
            const btn = document.getElementById('btnSubmit');
            const stat = document.getElementById('status');
            const txt = document.getElementById('loc-text');

            if(chk.checked) {
                txt.innerText = "ƒêang l·∫•y v·ªã tr√≠...";
                stat.innerHTML = "<b style='color:orange'>üì° ƒêang qu√©t GPS...</b>";
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        document.getElementById('lat').value = pos.coords.latitude;
                        document.getElementById('lng').value = pos.coords.longitude;
                        txt.innerHTML = "V·ªã tr√≠: <b style='color:#10b981'>ƒê√£ b·∫≠t</b>";
                        stat.innerHTML = "";
                        inputs.forEach(i => i.disabled=false);
                        btn.disabled=false; btn.innerHTML="G·ª≠i ƒêi·ªÉm Danh"; btn.style.background = "#0056b3";
                    }, err => {
                        stat.innerHTML = "<b style='color:red'>‚ö†Ô∏è L·ªói GPS: "+err.message+"</b>";
                        chk.checked=false;
                    });
                } else { alert("M√°y kh√¥ng h·ªó tr·ª£ GPS"); chk.checked=false; }
            } else {
                txt.innerText = "V·ªã tr√≠: ƒêang t·∫Øt";
                inputs.forEach(i => i.disabled=true);
                btn.disabled=true; btn.innerHTML="üîí Vui l√≤ng b·∫≠t v·ªã tr√≠"; btn.style.background = "#9ca3af";
            }
        }

        function handleStudentSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            const stat = document.getElementById('status');

            if (GOOGLE_SCRIPT_URL.includes("D√ÅN_LINK")) {
                alert("Ch∆∞a c·∫•u h√¨nh Script URL!"); return;
            }
            
            // --- L·∫§Y M√É PHI√äN T·ª™ URL ---
            const params = new URLSearchParams(window.location.search);
            const sessionCode = params.get('c') || "Kh√¥ng c√≥ m√£";

            const data = {
                name: document.getElementById('name').value,
                mssv: document.getElementById('mssv').value,
                lop: document.getElementById('lop').value,
                mon: document.getElementById('mon').value,
                lat: document.getElementById('lat').value,
                lng: document.getElementById('lng').value,
                deviceId: getDeviceId(),
                sessionCode: sessionCode // G·ª≠i m√£ phi√™n v·ªÅ Sheet
            };

            btn.disabled = true; btn.innerText = "‚è≥ ƒêang g·ª≠i...";
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST", mode: "no-cors",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(data)
            }).then(() => {
                localStorage.setItem('lastAttendanceTime', Date.now());
                stat.innerHTML = "<div style='color:#155724; background:#d4edda; padding:10px; border-radius:5px;'>‚úÖ ƒê√£ g·ª≠i th√†nh c√¥ng!<br>N·∫øu th√¥ng tin ƒë√∫ng, b·∫°n ƒë√£ ƒë∆∞·ª£c ƒëi·ªÉm danh.</div>";
                btn.innerText = "‚úÖ Ho√†n T·∫•t";
                setTimeout(() => { checkCooldown(); }, 2000);
            }).catch(err => {
                stat.innerHTML = "<div style='color:#721c24; background:#f8d7da; padding:10px; border-radius:5px;'>‚ùå L·ªói k·∫øt n·ªëi. Th·ª≠ l·∫°i!</div>";
                btn.disabled = false; btn.innerText = "Th·ª≠ L·∫°i";
            });
        }
    </script>
</body>
</html>
